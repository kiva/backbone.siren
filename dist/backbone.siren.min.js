/*
* Backbone.Siren v0.2.6
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
Backbone.Siren=function(e,t,i){"use strict";function n(t,i){var n;e.extend(this,{"class":[],method:"GET",type:"application/x-www-form-urlencoded"},t),this.class.indexOf("batch")>-1&&e.isEmpty(this.fields)&&(n=i.first(),n&&(this.fields=n.getActionByName(this.name).fields)),this.parent=i}function r(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})}function a(e){var t,i;if(e)return e.href?i=e.href:e.links?(t=e.links.filter(function(e){return!(!e.rel||!e.rel.filter(function(e){return"self"==e}).length)})[0],t&&(i=t.href)):(z('Missing href or "self" link'),i=""),i}function u(){return a(this._data)}function s(e){return e["class"]||[]}function o(t,i){return e.filter(t,function(e){return c(e,i)})}function c(e,t){var i=!0;return t.className&&(i=e.hasClass(t.className)),t.rel&&(i=e.hasRel(t.rel)),i}function l(e,t){var i=!0;return t.className&&(i=d(e,t.className)),t.name&&(i=e.name==t.name),i}function d(t,i){return e.indexOf(s(t),i)>-1}function F(e){return d(this._data,e)}function f(t){return e.indexOf(this.rels(),t)>-1}function h(){return s(this._data)}function v(t){var i=this._data.links;return t&&(i=e.filter(i,function(i){return e.indexOf(i.rel,t)>-1})),i||[]}function p(i){var n=[],r=this.links(i);return e.each(r,function(e){n.push($.getJSON(e.href,function(e){t.Siren.parseEntity(e)}))}),n}function m(i){i=i||{};var n=new $.Deferred;if(this.once("sync",function(e){n.resolve(e)}),i.forceFetch||this._data&&this._data.href&&!this._data.links)this.fetch(i);else if(e.isEmpty(this._data)){if(i.url){var r=this,a=t.Siren.parseChain(i.url),u=a.pop();delete i.url,u&&!a.length?this.resolve(e.extend(e.clone(i),{url:u,forceFetch:!0})).done(function(e){n.resolve(e)}):u&&t.Siren.resolve(a,i).done(function(t){r.resolve(e.extend(e.clone(i),{url:t.get(u).url(),forceFetch:!0})).done(function(e){n.resolve(e)})})}}else n.resolve(this);return n.promise()}function y(e,i){return _(this,t.Siren.parseChain(e),new $.Deferred,i)}function x(e){return e.rel||[]}function A(t){var i;return e.find(x(t),function(e){return i=/name:(.*)/.exec(e)}),e.last(i)}function D(e){return e.name||A(e)}function b(t){var i=this._actions;return t&&(i=e.filter(i,function(e){return l(e,t)})),i}function g(t){return e.find(this._actions,function(e){return e.name==t})}function S(){return this._data.title}function E(){var i=this,n=[];if(this._data)return e.each(this._data.actions,function(a){var u=new t.Siren.Action(a,i);n.push(u),a.name?i[r(a.name)]=e.bind(u.execute,u):z("Action is missing a name, unable to add top level method",a)}),i._actions=n,n}function _(e,i,n,r){r=r||{};var a=i.shift(),u=e.get(a);if(!u)throw'The entity you are looking for, "'+a+'" is not a sub-entity at '+e.url()+".";return r.deferred=n,t.Siren.resolve(u.url()+"#"+i.join("#"),r)}function C(t,i,n,r){e.isEmpty(i)?n.resolve(t):_(t,i,n,r)}var k={},N={},w={add:function(e){k[e.url()]=e},get:function(e){return k["object"==typeof e?a(e):e]},filter:function(t){return e.filter(k,function(e,i){return t.test(i)})},exists:function(e){return!!this.get(e instanceof t.Siren.Model?e.url():e)},all:function(){return k},clear:function(){k={}},addRequest:function(e,t){N[e]=t},getRequest:function(e){return N[e]}},z=function(){t.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return n.prototype={hasClass:function(e){return this.class.indexOf(e)>-1},getFieldByName:function(t){return e.find(this.fields,function(e){return e.name==t})},getSecureKeys:function(){var e=this.secureKeys;return e?e:(this.secureKeys=new t.Model,this.secureKeys)},setSecureKey:function(e,t){var i=this.getSecureKeys();i.set(e,t)},getSecureKey:function(e){var t=this.secureKeys;return t?t.get(e):i},clearSecureKeys:function(){return this.getSecureKeys().clear()},execute:function(n){n=n||{};var r,a,u=n.attributes,s=this.name,o=this.parent,c={url:this.href,actionName:s,success:function(e,i,n){o.trigger("sync:"+s,e,i,n),o instanceof t.Model?(o.attributes={},o.set(r.attributes)):o.set(r.models)},error:function(e,t,i){o.trigger("error: "+s,e,i)}};return delete n.attributes,o?(this.method&&(c.type=this.method),this.type&&(c.contentType=this.type),o instanceof t.Model?(r=o.clone(),r._data=o._data,r._actions=o._actions):r=o,n=e.extend(c,n),u=e.extend(o.toJSON({actionName:this.name}),u),a=r.save(u,n),o.validationError=r.validationError,a):i}},{settings:{showWarnings:!0},store:w,warn:z,Action:n,parse:function(e){var i;return i=d(e,"collection")?new t.Siren.Collection(e):d(e,"error")?new t.Siren.Model(e):new t.Siren.Model(e)},ajax:function(i,n){return n=e.extend({url:i,dataType:"json"},n),t.ajax(n)},parseChain:function(e){return"string"==typeof e&&(e=e.replace(/^#|#$/,"").split("#")),e},resolve:function m(i,n){n=n||{};var r,a,u,s,o=t.Siren.parseChain(i),c=o.shift(),l=n.deferred;return u=w.getRequest(c),u&&(r=u.state()),e.isEmpty(o)&&("resolved"==r&&!n.forceFetch||"pending"==r)?l?u.done(function(e){l.resolve(e)}):u:(l||(l=new $.Deferred),"pending"==r?u.done(function(e){_(e,o,l,n)}):n.forceFetch||!(s=w.get(c))?(a=new $.Deferred,w.addRequest(c,a.promise()),t.Siren.ajax(c,n).done(function(e){var i=t.Siren.parse(e);a.resolve(i),C(i,o,l,n)}).fail(function(e){var i=JSON.parse(e.responseText||"{}"),n=t.Siren.parse(i);a.reject(n,e),l.reject(n,e)})):C(s,o,l,n),l.promise())},Model:t.Model.extend({url:u,classes:h,hasClass:F,hasRel:f,title:S,actions:b,links:v,getActionByName:g,parseActions:E,request:p,resolve:m,resolveChain:y,resolveEntities:function(t){var i=this,n=[];return e.each(this._data.entities,function(e){n.push(i.resolveEntity(e,t))}),$.when(n).done(function(){i.trigger("resolve",i)})},resolveEntity:function(e,i){i=i||{};var n,r,u=this,s=new $.Deferred;return e.href&&"linked"==i.autoFetch||"all"==i.autoFetch?t.Siren.resolve(a(e),i).done(function(t){s.resolve(u.setEntity(t,x(e),D(e)))}):(n=t.Siren.parse(e),r=s.resolve(this.setEntity(n,x(e),D(e)))),r},setEntity:function(e,t,i){var n={rel:t,entity:e};return i&&(this.set(i,e),n.name=i),this._entities.push(n),e},parse:function(e,t){return this._data=e,this._entities=[],this.resolveEntities(t),e.links&&!e.href&&w.add(this),e.properties},toJSON:function(i){var n,r={},a=this;return i&&i.actionName&&(n=this.getActionByName(i.actionName)),n?e.each(n.fields,function(e){var i=a.get(e.name);r[e.name]=i instanceof t.Siren.Model||i instanceof t.Siren.Collection?i.toJSON({actionName:e.action}):i}):e.each(this.attributes,function(e,n){r[n]=e instanceof t.Siren.Model||e instanceof t.Siren.Collection?e.toJSON(i):e}),r},entities:function(t){var i=e.map(this._entities,function(e){return e.entity});return t&&(i=o(i,t)),i},constructor:function(e,i){i=i||{},i.parse=!0,t.Model.call(this,e,i),this.parseActions()}}),Collection:t.Collection.extend({url:u,classes:h,hasClass:F,hasRel:f,title:S,links:v,actions:b,getActionByName:g,parseActions:E,request:p,resolve:m,resolveChain:y,filter:function(t){return"function"==typeof t?e.filter(this,t):o(this,t)},parse:function(i){this._data=i,this._meta=i.properties||{};var n=[];return e.each(i.entities,function(e){n.push(new t.Siren.Model(e))}),n},meta:function(e){return this._meta[e]},toJSON:function(e){return e=e||{},this.map(function(t){var i=t.toJSON(e);return e.actionName&&(i.id=t.id),i})},save:function(t,n){return n=e.extend({validate:!0},n),this._validate&&this._validate(t,n),n.parse===i&&(n.parse=!0),this.sync("create",this,n)},constructor:function(e,i){i=i||{},i.parse=!0,t.Collection.call(this,e,i),this.parseActions()}})}}(_,Backbone),function(e,t){"use strict";t.Siren.validate={customPatterns:{},standardPatterns:{},setPatterns:function(t){var i=this,n="color date datetime datetime-local email month number range search tel time url week";e.each(t,function(e,t){-1==n.indexOf(t)?i.customPatterns[t]=e:i.standardPatterns[t]=e})}},e.extend(t.Siren.Model.prototype,{_validate:function(e,t){var i;return!t.xhr&&t.validate&&this.validate?(i=this.validationError=this.validate(e,t)||null,i&&this.trigger("invalid",this,i,t||{}),!(i&&!t.forceUpdate)):!0},validateEmptyField:function(e){return e.required?{valid:!1,valueMissing:!0}:{}},validateSubEntity:function(e,t){var i=t.action;return e._validate(e.toJSON({actionName:i}),{validate:!0,actionName:i})?{}:{customError:!0,valid:!1}},validateType:function(e,i){var n={},r=i.type,a=t.Siren.validate.customPatterns[r]||t.Siren.validate.standardPatterns[r];return(a&&!a.test(e)||"checkbox"==r&&"boolean"!=typeof e)&&(n.valid=!1,n.typeMismatch=!0),n},validateConstraints:function(e,t){var i={},n=t.type;return t.pattern&&!RegExp(t.pattern).test(e)&&(i.valid=!1,i.patternMismatch=!0),"number"==n||"range"==n?(t.min&&t.min>e&&(i.valid=!1,i.rangeUnderflow=!0),t.max&&e>t.max&&(i.valid=!1,i.rangeOverflow=!0),t.step&&e%t.step&&(i.valid=!1,i.stepMismatch=!0)):"text email search password tel url".indexOf(n)>-1?t.maxlength&&t.maxlength<e.length&&(i.valid=!1,i.tooLong=!0):"file"==n&&t.maxSize&&t.maxSize<e.length&&(i.valid=!1,i.customError=!0),i},validateOne:function(i,n){var r={valueMissing:!1,typeMismatch:!1,patternMismatch:!1,tooLong:!1,rangeUnderflow:!1,rangeOverflow:!1,stepMismatch:!1,badInput:!1,customError:!1,valid:!0};return void 0===i||""===i?r=e.extend(r,this.validateEmptyField(n)):(e.extend(r,this.validateType(i,n)),r.typeMismatch||(i instanceof t.Model?e.extend(r,this.validateSubEntity(i,n)):e.extend(r,this.validateConstraints(i,n)))),r},validate:function(t,i){i=i||{};var n=this,r=i.actionName,a=this.getActionByName(r),u={};return a?e.each(t,function(e,t){var r,s=a.getFieldByName(t);return s?(r=n.validateOne(e,s,i),r.valid||(u[t]=r),void 0):!0}):u["no-actions"]='There are no actions matching the name, "'+r+'"',e.isEmpty(u)?void 0:u}}),e.extend(t.Siren.Collection.prototype,{validate:function(t,i){var n,r=this;return e.each(t,function(e){if(!e.id)return!0;var t=r.get(e.id),a=t.validate(e,i);a&&(n[e.id]=a)}),e.isEmpty(n)?void 0:n},_validate:function(t,i){var n;return i.validate&&this.validate?(t=e.extend({},this.attributes,t),(n=this.validationErrors=this.validate(t,i)||null)?(this.trigger("invalid",this,n,e.extend(i||{},{validationErrors:n})),!1):!0):!0}})}(_,Backbone);var patternLibrary={phone:/([\+][0-9]{1,3}([ \.\-])?)?([\(]{1}[0-9]{3}[\)])?([0-9A-Z \.\-]{1,32})((x|ext|extension)?[0-9]{1,4}?)/,email:/((([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?/,url:/(https?|ftp):\/\/(((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?/,number:/-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?/,dateISO:/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/,alpha:/[a-zA-Z]+/,alphaNumeric:/\w+/,integer:/-?\d+/};Backbone.Siren.validate.setPatterns(patternLibrary),function(e,t){"use strict";e.extend(t.Siren.Model.prototype,{})}(_,Backbone),function(e,t){"use strict";t.Siren.FormView=t.View.extend({tagName:"form",_events:{submit:"handleFormSubmit"},handleFormSubmit:function(i){i.preventDefault();var n=this,r={};e.each(this.fieldAttributes,function(e,i){var a=e.model;a&&(a instanceof t.Model?r[i]=a.get(i):e.isSecure?(r[i]=a.action.getSecureKey(i),a.action.clearSecurekeys()):"function"==typeof a&&(r[i]=a.call(n)))}),this.model.getActionByName(this.action.name).execute({attributes:r})},template:function(t){var i='<% _.each(data.fieldAttributes, function (field, fieldName) { %>                     <div>                         <% if (field.label) { %><label for="<%= field.id %>"><%= field.label %></label><% } %>                         <% if ((field.type == "radio" || field.type == "checkbox") && _.isArray(field.value)) { %>                            <% _.each(field.options, function (checked, val) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= val %>"  <%= checked %> /><% }); %>                        <% } else if ((field.type == "radio" || field.type == "checkbox") && _.isObject(field.value)) { %>                            <% _.each(field.options, function (option, name) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= option.value %>"  <%= option.checked %> /><label><%= option.label %></label><% }); %>                        <% } else { %>                             <input type="<%= field.type %>" name="<%= fieldName %>" <% if (field.id) { %> id="<%= field.id %>" <% } if (field.value) { %> value="<%= field.value %>" <% } %>  <%= field.checked %> <%= field.required %> />                         <% } %>                     </div>                 <% }); %> <button type="submit" class="submitButton">Submit</button>';return e.template(i,t,{variable:"data"})},parseAttributes:function(e,t){return t=t||{},{id:t.id||e.name+"-form",enctype:t.enctype||e.type,method:t.method||e.method,action:t.action||e.href,title:t.title||e.title,novalidate:!t.validation}},parseFieldAttributes:function(t,i){i=i||{};var n={},r=t.fields;return e.each(r,function(r){var a,u,s;if("entity"==r.type?console.log("@todo - how to handle sub-entity views?"):"entity"!=r.type&&(a=r.name,s=t.parent.get(a),u=e.extend({value:s,type:"text"},r,i[a]),"checkbox"==u.type?e.isArray(u.value)?(u.options={},e.each(u.value,function(e){u.options[e]=s==e?"checked":""})):e.isObject(u.value)?(u.options=[],e.each(u.value,function(t,i){u.options.push({value:t,label:i,checked:e.indexOf(s,t)>-1?"checked":""})})):u.checked=u.value?"checked":"":"radio"==u.type&&(e.isArray(u.value)?(u.options={},e.each(u.value,function(e){u.options[e]=s==e?"checked":""})):e.isObject(u.value)&&(u.options=[],e.each(u.value,function(e,t){u.options.push({value:t,label:e,checked:s==t?"checked":""})}))),u.required=u.required?"required":""),u){var o=a.split("."),c=n,l=o.length;e.each(o,function(e,t){c[e]||(c[e]=t==l-1?u:{}),c=c[e]})}}),n},setFieldAttributes:function(t){var i={};return e.each(this.fieldAttributes,function(e,n){i[n]=$.extend(e,t[n])}),this.fieldAttributes=i,this},getFieldAttributes:function(){return this.fieldAttributes},render:function(){var t={fieldAttributes:this.fieldAttributes};return this.templateHelpers&&e.extend(t,this.templateHelpers),this.$el.html(this.template(t)),this},setAction:function(e){if(!(e.parent instanceof t.Siren.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone.Siren Model';return this.action=e,this.model=e.parent,this},initializeForm:function(e){var t=e.action;if(!t)throw'Missing required property: "action"';this.setAction(t),this.cid?this.$el.attr(this.parseAttributes(t,e.attributes)):e.attributes=this.parseAttributes(e.action,e.attributes),this.fieldAttributes=this.parseFieldAttributes(t,e.fieldAttributes)},initialize:function(){this.render()},constructor:function(i){i=i||{},i.action&&this.initializeForm(i),this.events=e.extend(this._events,this.events),t.View.call(this,i)}})}(_,Backbone);