/*
* Backbone.Siren v0.2.14
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
Backbone.Siren=function(e,t,n){"use strict";function i(t,n){var i;e.extend(this,{"class":[],method:"GET",type:"application/x-www-form-urlencoded"},t),this["class"].indexOf("batch")>-1&&e.isEmpty(this.fields)&&(i=n.first(),i&&(this.fields=i.getActionByName(this.name).fields)),this.parent=n}function r(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})}function s(t){var n,i;if(t)return t.href?i=t.href:t.links?(n=e.filter(t.links,function(t){return!(!t.rel||!e.filter(t.rel,function(e){return"self"==e}).length)})[0],n&&(i=n.href)):(O('Missing href or "self" link'),i=""),i}function o(){return s(this._data)}function a(e){return e["class"]||[]}function c(t,n){return e.filter(t,function(e){return u(e,n)})}function u(e,t){var n=!0;return t.className&&(n=e.hasClass(t.className)),t.rel&&(n=e.hasRel(t.rel)),n}function l(e,t){var n=!0;return t.className&&(n=f(e,t.className)),t.name&&(n=e.name==t.name),n}function f(t,n){return e.indexOf(a(t),n)>-1}function h(e){return f(this._data,e)}function d(t){return e.indexOf(this.rels(),t)>-1}function p(){return a(this._data)}function v(t){var n=this._data.links;return t&&(n=e.filter(n,function(n){return e.indexOf(n.rel,t)>-1})),n||[]}function m(n){var i=e.find(this._data.links,function(t){return e.indexOf(t.rel,n)>-1});if(i)return t.Siren.resolve(i.href)}function y(n){n=n||{};var i=new $.Deferred;if(this.once("sync",function(e){i.resolve(e)}),n.forceFetch||this._data&&this._data.href&&!this._data.links)this.fetch(n);else if(e.isEmpty(this._data)){if(n.url){var r=this,s=t.Siren.parseChain(n.url),o=s.pop();delete n.url,o&&!s.length?this.resolve(e.extend(e.clone(n),{url:o,forceFetch:!0})).done(function(e){i.resolve(e)}):o&&t.Siren.resolve(s,n).done(function(t){r.resolve(e.extend(e.clone(n),{url:t.get(o).url(),forceFetch:!0})).done(function(e){i.resolve(e)})})}}else i.resolve(this);return i.promise()}function b(e,n){return w(this,t.Siren.parseChain(e),new $.Deferred,n)}function g(e){return e.rel||[]}function S(t){var n;return e.find(g(t),function(e){return n=/name:(.*)/.exec(e)}),e.last(n)}function _(e){return e.name||S(e)}function x(t){var n=this._actions;return t&&(n=e.filter(n,function(e){return l(e,t)})),n}function A(t){return e.find(this._actions,function(e){return e.name==t})}function k(){return this._data.title}function N(){var n=this,i=[];if(this._data)return e.each(this._data.actions,function(s){var o=new t.Siren.Action(s,n);i.push(o),s.name?n[r(s.name)]=e.bind(o.execute,o):O("Action is missing a name, unable to add top level method",s)}),n._actions=i,i}function w(e,n,i,r){r=r||{};var s=n.shift(),o=e.get(s);if(!o)throw'The entity you are looking for, "'+s+'" is not a sub-entity at '+e.url()+".";return r.deferred=i,t.Siren.resolve(o.url()+"#"+n.join("#"),r)}function q(t,n,i,r){e.isEmpty(n)?i.resolve(t):w(t,n,i,r)}var C={},F={},M={add:function(e){C[e.url()]=e},get:function(e){return C["object"==typeof e?s(e):e]},filter:function(t){return e.filter(C,function(e,n){return t.test(n)})},exists:function(e){return!!this.get(e instanceof t.Siren.Model?e.url():e)},all:function(){return C},clear:function(){C={}},addRequest:function(e,t){F[e]=t},getRequest:function(e){return F[e]}},O=function(){t.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return i.prototype={hasClass:function(e){return this["class"].indexOf(e)>-1},getFieldByName:function(t){return e.find(this.fields,function(e){return e.name==t})},getSecureKeys:function(){var e=this.secureKeys;return e?e:(this.secureKeys=new t.Model,this.secureKeys)},setSecureKey:function(e,t){var n=this.getSecureKeys();n.set(e,t)},getSecureKey:function(e){var t=this.secureKeys;return t?t.get(e):n},clearSecureKey:function(e){return this.getSecureKeys().unset(e)},clearSecureKeys:function(){return this.getSecureKeys().clear()},execute:function(i){i=i||{};var r,s,o=i.attributes,a=this.name,c=this.parent,u={url:this.href,actionName:a,success:function(e,n,i){c.trigger("sync:"+a,e,n,i),c instanceof t.Model?(c.attributes={},c.set(r.attributes)):c.set(r.models)},error:function(e,t,n){c.trigger("error:"+a,e,t,n)}};return delete i.attributes,c?(this.method&&(u.type=this.method),this.type&&(u.contentType=this.type),c instanceof t.Model?(r=c.clone(),r._data=c._data,r._actions=c._actions,r.on("request",function(e,t,n){c.trigger("request",e,t,n),c.trigger("request:"+a,e,t,n)})):(r=c,c.on("request",function(e,t,n){c.trigger("request:"+a,e,t,n)})),i=e.extend(u,i),o=e.extend(c.toJSON({actionName:this.name}),o),s=r.save(o,i),c.validationError=r.validationError,s):n}},{settings:{showWarnings:!0},store:M,warn:O,Action:i,parse:function(e){var n;return n=f(e,"collection")?new t.Siren.Collection(e):f(e,"error")?new t.Siren.Model(e):new t.Siren.Model(e)},ajax:function(n,i){return i=e.extend({url:n,dataType:"json"},i),t.ajax(i)},parseChain:function(e){return"string"==typeof e&&(e=e.replace(/^#|#$/,"").split("#")),e},resolve:function y(n,i){i=i||{};var r,s,o,a,c=t.Siren.parseChain(n),u=c.shift(),l=i.deferred;return o=M.getRequest(u),o&&(r=o.state()),e.isEmpty(c)&&("resolved"==r&&!i.forceFetch||"pending"==r)?l?o.done(function(e){l.resolve(e)}):o:(l||(l=new $.Deferred),"pending"==r?o.done(function(e){w(e,c,l,i)}):i.forceFetch||!(a=M.get(u))?(s=new $.Deferred,M.addRequest(u,s.promise()),t.Siren.ajax(u,i).done(function(e){var n=t.Siren.parse(e);s.resolve(n),q(n,c,l,i)}).fail(function(e){var n,i;try{n=JSON.parse(e.responseText)}catch(r){n={}}i=t.Siren.parse(n),s.reject(i,e),l.reject(i,e)})):q(a,c,l,i),l.promise())},Model:t.Model.extend({url:o,classes:p,hasClass:h,hasRel:d,title:k,actions:x,links:v,getActionByName:A,parseActions:N,request:m,resolve:y,resolveChain:b,resolveEntities:function(t){var n=this,i=[];return e.each(this._data.entities,function(e){i.push(n.resolveEntity(e,t))}),$.when(i).done(function(){n.trigger("resolve",n)})},resolveEntity:function(e,n){n=n||{};var i,r,o=this,a=new $.Deferred;return e.href&&"linked"==n.autoFetch||"all"==n.autoFetch?t.Siren.resolve(s(e),n).done(function(t){a.resolve(o.setEntity(t,g(e),_(e)))}):(i=t.Siren.parse(e),r=a.resolve(this.setEntity(i,g(e),_(e)))),r},setEntity:function(e,t,n){var i={rel:t,entity:e};return n&&(this.set(n,e),i.name=n),this._entities.push(i),e},parse:function(e,t){return this._data=e,this._entities=[],this.resolveEntities(t),e.links&&!e.href&&M.add(this),e.properties},toJSON:function(n){var i,r={},s=this;return n&&n.actionName&&(i=this.getActionByName(n.actionName)),i?e.each(i.fields,function(e){var n=s.get(e.name);r[e.name]=n instanceof t.Siren.Model||n instanceof t.Siren.Collection?n.toJSON({actionName:e.action}):n}):e.each(this.attributes,function(e,i){r[i]=e instanceof t.Siren.Model||e instanceof t.Siren.Collection?e.toJSON(n):e}),r},entities:function(t){var n=e.map(this._entities,function(e){return e.entity});return t&&(n=c(n,t)),n},constructor:function(e,n){n=n||{},n.parse=!0,t.Model.call(this,e,n),this.parseActions()}}),Collection:t.Collection.extend({url:o,classes:p,hasClass:h,hasRel:d,title:k,links:v,actions:x,getActionByName:A,parseActions:N,request:m,resolve:y,resolveChain:b,filter:function(t){return"function"==typeof t?e.filter(this.models,t):c(this,t)},parse:function(n){this._data=n,this._meta=n.properties||{};var i=[];return e.each(n.entities,function(e){i.push(new t.Siren.Model(e))}),i},meta:function(e){return this._meta[e]},toJSON:function(e){return e=e||{},this.map(function(t){var n=t.toJSON(e);return e.actionName&&(n.id=t.id),n})},save:function(t,i){return i=e.extend({validate:!0},i),this._validate&&this._validate(t,i),i.parse===n&&(i.parse=!0),this.sync("create",this,i)},constructor:function(e,n){n=n||{},n.parse=!0,t.Collection.call(this,e,n),this.parseActions()}})}}(_,Backbone),function(e,t){"use strict";t.Siren.FormView=t.View.extend({tagName:"form",_events:{submit:"handleFormSubmit"},handleFormSubmit:function(n){n.preventDefault();var i=this,r={};e.each(this.fieldAttributes,function(e,n){var s=e.model;s&&(s instanceof t.Model?r[n]=s.get(n):e.isSecure?(r[n]=s.action.getSecureKey(n),s.action.clearSecurekeys()):"function"==typeof s&&(r[n]=s.call(i)))}),this.model.getActionByName(this.action.name).execute({attributes:r})},template:function(t){var n='<% _.each(data.fieldAttributes, function (field, fieldName) { %>                     <div>                         <% if (field.label) { %><label for="<%= field.id %>"><%= field.label %></label><% } %>                         <% if ((field.type == "radio" || field.type == "checkbox") && _.isArray(field.value)) { %>                            <% _.each(field.options, function (checked, val) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= val %>"  <%= checked %> /><% }); %>                        <% } else if ((field.type == "radio" || field.type == "checkbox") && _.isObject(field.value)) { %>                            <% _.each(field.options, function (option, name) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= option.value %>"  <%= option.checked %> /><label><%= option.label %></label><% }); %>                        <% } else { %>                             <input type="<%= field.type %>" name="<%= fieldName %>" <% if (field.id) { %> id="<%= field.id %>" <% } if (field.value) { %> value="<%= field.value %>" <% } %>  <%= field.checked %> <%= field.required %> />                         <% } %>                     </div>                 <% }); %> <button type="submit" class="submitButton">Submit</button>';return e.template(n,t,{variable:"data"})},parseAttributes:function(e,t){return t=t||{},{id:t.id||e.name+"-form",enctype:t.enctype||e.type,method:t.method||e.method,action:t.action||e.href,title:t.title||e.title,novalidate:!t.validation}},parseFieldAttributes:function(t,n){n=n||{};var i={},r=t.fields;return e.each(r,function(r){var s,o,a;if("entity"==r.type?console.log("@todo - how to handle sub-entity views?"):"entity"!=r.type&&(s=r.name,a=t.parent.get(s),o=e.extend({value:a,type:"text"},r,n[s]),"checkbox"==o.type?e.isArray(o.value)?(o.options={},e.each(o.value,function(e){o.options[e]=a==e?"checked":""})):e.isObject(o.value)?(o.options=[],e.each(o.value,function(t,n){o.options.push({value:t,label:n,checked:e.indexOf(a,t)>-1?"checked":""})})):o.checked=o.value?"checked":"":"radio"==o.type&&(e.isArray(o.value)?(o.options={},e.each(o.value,function(e){o.options[e]=a==e?"checked":""})):e.isObject(o.value)&&(o.options=[],e.each(o.value,function(e,t){o.options.push({value:t,label:e,checked:a==t?"checked":""})}))),o.required=o.required?"required":""),o){var c=s.split("."),u=i,l=c.length;e.each(c,function(e,t){u[e]||(u[e]=t==l-1?o:{}),u=u[e]})}}),i},setFieldAttributes:function(t){var n={};return e.each(this.fieldAttributes,function(e,i){n[i]=$.extend(e,t[i])}),this.fieldAttributes=n,this},getFieldAttributes:function(){return this.fieldAttributes},render:function(){var t={fieldAttributes:this.fieldAttributes};return this.templateHelpers&&e.extend(t,this.templateHelpers),this.$el.html(this.template(t)),this},setAction:function(e){if(!(e.parent instanceof t.Siren.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone.Siren Model';return this.action=e,this.model=e.parent,this},initializeForm:function(e){var t=e.action;if(!t)throw'Missing required property: "action"';this.setAction(t),this.cid?this.$el.attr(this.parseAttributes(t,e.attributes)):e.attributes=this.parseAttributes(e.action,e.attributes),this.fieldAttributes=this.parseFieldAttributes(t,e.fieldAttributes)},initialize:function(){this.render()},constructor:function(n){n=n||{},n.action&&this.initializeForm(n),this.events=e.extend(this._events,this.events),t.View.call(this,n)}})}(_,Backbone);