/*
* Backbone.Siren v0.3.1
*
* Copyright (c) 2014 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
define(["jquery","underscore","backbone"],function(a,b,c){"use strict";function d(a){return a.replace(/(\-[a-z])/g,function(a){return a.toUpperCase().replace("-","")})}function e(a){var c,d;return a.href?d=a.href:a.links?(c=b.filter(a.links,function(a){return!(!a.rel||!b.filter(a.rel,function(a){return"self"==a}).length)})[0],c&&(d=c.href)):(x('Missing href or "self" link'),d=""),d}function f(a){var c;return b.find(a.rel,function(a){return c=/name:(.*)/.exec(a)}),b.last(c)}function g(a){return a.name||f(a)}function h(a,c){return b.indexOf(a["class"],c)>-1}function i(a){return b.indexOf(this.classes(),a)>-1}function j(a){return b.indexOf(this.rel(),a)>-1}function k(){return e(this._data)}function l(){return this._data["class"]||[]}function m(){return this._data.title}function n(){return this._data.rel||[]}function o(){return this._data.links||[]}function p(){return this._actions||[]}function q(a){return b.find(this._actions,function(b){return b.name==a})}function r(a){var b=!0;return a["class"]&&(b=this.hasClass(a["class"])),a.rel&&(b=this.hasRel(a.rel)),b}function s(a){var c=b.find(this._data.links,function(c){return b.indexOf(c.rel,a)>-1});if(c)return w.resolveOne(c.href)}function t(c){c=c||{};var d=new a.Deferred;if(this.once("sync",function(a){d.resolve(a)}),c.forceFetch||!this.isLoaded)this.fetch(c);else if(b.isEmpty(this._data)){if(c.url){var e=this,f=w.parseChain(c.url),g=f.pop();delete c.url,g&&b.isEmpty(f)?this.resolve(b.extend(b.clone(c),{url:g,forceFetch:!0})).done(function(a){d.resolve(a)}):g&&w.resolveOne(w.stringifyChain(f),c).done(function(a){e.resolve(b.extend(b.clone(c),{url:a.get(g).url(),forceFetch:!0})).done(function(a){d.resolve(a)})})}}else d.resolve(this);return d.promise()}function u(c,d){d=d||{};var e,f,g;if(d.deferred||(d.deferred=new a.Deferred),!b.isArray(c)||b.isEmpty(c))return d.deferred.resolve(this);if(e=c.shift(),f=w.isCollection(this)?this.at(e):this.get(e),!f)throw new ReferenceError('The entity you are looking for, "'+e+'" is not a sub-entity at '+this.url()+".");return g=w.stringifyChain(c),g=g?f.url()+"#"+g:f.url(),w.resolveOne(g,d)}function v(){var a=this,c=[];if(this._data)return b.each(this._data.actions,function(e){var f=new w.Action(e,a);c.push(f),e.name?a[d(e.name)]=b.bind(f.execute,f):x("Action is missing a name, unable to add top level method",e)}),a._actions=c,c}var w,x=function(){w.settings.showWarnings&&console&&console.warn.apply(console,arguments)};w=c.Siren=function(a,b){this.store=new c.Siren.Store,this.init(a,b)},b.extend(w,{settings:{showWarnings:!0},warn:x,isHydratedObject:function(a){return!(!a||!a.cid&&!a.models||!a._data)},isLoaded:function(a){return!(!a.links||a.href)},isCollection:function(a){return a instanceof c.Siren.Collection},isRawCollection:function(a){return h(a,"collection")},isRawError:function(a){return h(a,"error")},parse:function(a,b){var d;return d=w.isRawCollection(a)?new c.Siren.Collection(a,{store:b}):w.isRawError(a)?new c.Siren.Model(a,{store:b}):new c.Siren.Model(a,{store:b})},ajax:function(a,d){return d=b.extend({url:a,dataType:"json"},d),c.ajax(d)},parseChain:function(a){return"string"!=typeof a&&new TypeError("Must be a string"),a.replace(/^#|#$/,"").split("#")},stringifyChain:function(a){return b.isArray(a)||new TypeError("Must be an array"),a.join("#")},resolve:function(a,c){return b.isArray(a)?w.resolveMany(a,c):w.resolveOne(a,c)},resolveMany:function(c,d){d=d||{};var e=this,f=b.map(c,function(a){return e.resolveOne(a,b.clone(d))});return a.when.apply(a,f)},resolveOne:function(c,d){d=d||{};var e,f,g,h,i,j=w.parseChain(c),k=j.shift(),l=d.deferred;return d.store&&(e=d.store),e&&(h=e.getRequest(k),h&&(f=h.state())),b.isEmpty(j)&&("resolved"==f&&!d.forceFetch||"pending"==f)?l?h.done(function(a){l.resolve(a)}):h:(l||(l=new a.Deferred),"pending"==f?h.done(function(a){d.deferred=l,a.resolveNextInChain(j,d)}):(e&&(i=e.get(k)),i&&i.isLoaded&&!d.forceFetch?(d.deferred=l,i.resolveNextInChain(j,d)):(g=new a.Deferred,e&&e.addRequest(k,g.promise()),w.ajax(k,d).done(function(a){var b=w.parse(a,e);g.resolve(b),d.deferred=l,b.resolveNextInChain(j,d)}).fail(function(a){var b,c;try{b=JSON.parse(a.responseText)}catch(d){b={}}c=w.parse(b,e),g.reject(c,a),l.reject(c,a)}))),l.promise())},Model:c.Model.extend({url:k,classes:l,rel:n,actions:p,links:o,title:m,hasClass:i,hasRel:j,getActionByName:q,parseActions:v,match:r,request:s,resolve:t,resolveNextInChain:u,resolveEntities:function(c){var d=this,e=[];return b.each(this._data.entities,function(a){e.push(d.resolveEntity(a,c))}),a.when(e).done(function(){d.trigger("resolve",d)})},resolveEntity:function(b,c){c=c||{};var d,f,h=this,i=new a.Deferred;return b.href&&"linked"==c.autoFetch||"all"==c.autoFetch?w.resolveOne(e(b),c).done(function(a){i.resolve(h.setEntity(a,b.rel,g(b)))}):(d=w.parse(b,c.store),f=i.resolve(this.setEntity(d,b.rel,g(b)))),f},setEntity:function(a,b,c){var d={rel:b,entity:a};return c&&(this.set(c,a),d.name=c),this._entities.push(d),a},parse:function(a,b){return this._data=a,this._entities=[],this.isLoaded=w.isLoaded(a),this.resolveEntities(b),b.store&&b.store.add(this),a.properties},toJSON:function(a){var d,e={},f=this;return a&&a.actionName&&(d=this.getActionByName(a.actionName)),d?b.each(d.fields,function(a){var b=f.get(a.name);e[a.name]=w.isHydratedObject(b)?b.toJSON({actionName:a.action}):b}):b.each(this.attributes,function(b,d){e[d]=b instanceof c.Siren.Model||b instanceof c.Siren.Collection?b.toJSON(a):b}),e},entities:function(a){var c=b.map(this._entities,function(a){return a.entity});return a&&(c=b.filter(c,function(b){return b.match(a)})),c},isNew:function(){return!this.url()},constructor:function(a,b){b=b||{},b.parse=!0,c.Model.call(this,a,b),this.parseActions()}}),Collection:c.Collection.extend({url:k,classes:l,rel:n,actions:p,links:o,title:m,hasClass:i,hasRel:j,getActionByName:q,parseActions:v,match:r,request:s,resolve:t,resolveNextInChain:u,parse:function(a,d){d=d||{},this._data=a,this._meta=a.properties||{},this.isLoaded=w.isLoaded(a);var e=[];return b.each(a.entities,function(a){e.push(new c.Siren.Model(a,d))}),d.store&&d.store.add(this),e},meta:function(a){return this._meta[a]},toJSON:function(a){return a=a||{},this.map(function(b){var c=b.toJSON(a);return a.actionName&&(c.id=b.id),c})},save:function(a,c){return c=b.extend({validate:!0},c),this._validate&&this._validate(a,c),void 0===c.parse&&(c.parse=!0),this.sync("create",this,c)},constructor:function(a,b){b=b||{},b.parse=!0,c.Collection.call(this,a,b),this.parseActions()}})}),w.prototype={init:function(a,b){this.apiRoot=a,this.options=b},entityPathToUrl:function(a){return this.apiRoot+"/"+a},resolve:function(a,c){c=c||{},c.store=this.store;var d=this,e=[];return e="string"==typeof a?this.entityPathToUrl(a):b.map(a,function(a){return d.entityPathToUrl(a)}),w.resolve(e,c)}};var y=c.Siren.Action=function(a,c){var d;b.extend(this,{"class":[],method:"GET",type:"application/x-www-form-urlencoded"},a),b.indexOf(this["class"],"batch")>-1&&b.isEmpty(this.fields)&&(d=c.first(),d&&(this.fields=d.getActionByName(this.name).fields)),this.parent=c};y.prototype={hasClass:function(a){return b.indexOf(this["class"],a)>-1},match:function(a){var b=!0;return a?(a["class"]&&(b=this.hasClass(a["class"])),a.name&&(b=this.name==a.name),b):b},getFieldByName:function(a){return b.find(this.fields,function(b){return b.name==a})},getSecureKeys:function(){var a=this.secureKeys;return a?a:(this.secureKeys=new c.Model,this.secureKeys)},getSecureKey:function(a){var b=this.secureKeys;return b?b.get(a):void 0},setSecureKey:function(a,b){return this.getSecureKeys().set(a,b)},clearSecureKeys:function(){return this.getSecureKeys().clear()},clearSecureKey:function(a){return this.getSecureKeys().unset(a)},execute:function(a){a=a||{};var d,e,f=a.attributes,g=this.name,h=this.parent,i={url:this.href,actionName:g,success:function(a,b,e){h.trigger("sync:"+g,a,b,e),h instanceof c.Model?(h.attributes={},h.set(d.attributes)):h.set(d.models)},error:function(a,b,c){h.trigger("error:"+g,a,b,c)}};return delete a.attributes,h?(this.method&&(i.type=this.method),this.type&&(i.contentType=this.type),"PATCH"==i.type&&(a.patch=!0),h instanceof c.Model?(d=h.clone(),d._data=h._data,d._actions=h._actions,d.on("request",function(a,b,c){h.trigger("request",a,b,c),h.trigger("request:"+g,a,b,c)})):(d=h,h.on("request",function(a,b,c){h.trigger("request:"+g,a,b,c)})),a=b.extend(i,a),f=b.extend(h.toJSON({actionName:this.name}),f),e=d.save(f,a),h.validationError=d.validationError,e):void 0}};var z=c.Siren.Store=function(){this.data={},this.requests={}};return z.prototype={add:function(a){var b=this;return c.Siren.isCollection(a)&&a.each(function(a){b.add(a)}),this.data[a.url()]=a,a},get:function(a){return this.data["object"==typeof a?e(a):a]},filter:function(a){return b.filter(this.data,function(b,c){return a.test(c)})},exists:function(a){return!!this.get(c.Siren.isHydratedObject(a)?a.url():a)},addRequest:function(a,b){var c=this;return b.done(function(){c.requests[a]=null}),this.requests[a]=b,b},getRequest:function(a){return this.requests[a]}},c.Siren.FormView=c.View.extend({tagName:"form",_events:{submit:"handleFormSubmit"},handleFormSubmit:function(a){a.preventDefault();var d=this,e={};b.each(this.fieldAttributes,function(a,b){var f=a.model;f&&(f instanceof c.Model?e[b]=f.get(b):a.isSecure?(e[b]=f.action.getSecureKey(b),f.action.clearSecurekeys()):"function"==typeof f&&(e[b]=f.call(d)))}),this.model.getActionByName(this.action.name).execute({attributes:e})},template:function(a){var c='<% _.each(data.fieldAttributes, function (field, fieldName) { %>                     <div>                         <% if (field.label) { %><label for="<%= field.id %>"><%= field.label %></label><% } %>                         <% if ((field.type == "radio" || field.type == "checkbox") && _.isArray(field.value)) { %>                            <% _.each(field.options, function (checked, val) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= val %>"  <%= checked %> /><% }); %>                        <% } else if ((field.type == "radio" || field.type == "checkbox") && _.isObject(field.value)) { %>                            <% _.each(field.options, function (option, name) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= option.value %>"  <%= option.checked %> /><label><%= option.label %></label><% }); %>                        <% } else { %>                             <input type="<%= field.type %>" name="<%= fieldName %>" <% if (field.id) { %> id="<%= field.id %>" <% } if (field.value) { %> value="<%= field.value %>" <% } %>  <%= field.checked %> <%= field.required %> />                         <% } %>                     </div>                 <% }); %> <button type="submit" class="submitButton">Submit</button>';return b.template(c,a,{variable:"data"})},parseAttributes:function(a,b){return b=b||{},{id:b.id||a.name+"-form",enctype:b.enctype||a.type,method:b.method||a.method,action:b.action||a.href,title:b.title||a.title,novalidate:!b.validation}},parseFieldAttributes:function(a,c){c=c||{};var d={},e=a.fields;return b.each(e,function(e){var f,g,h;if("entity"==e.type?console.log("@todo - how to handle sub-entity views?"):"entity"!=e.type&&(f=e.name,h=a.parent.get(f),g=b.extend({value:h,type:"text"},e,c[f]),"checkbox"==g.type?b.isArray(g.value)?(g.options={},b.each(g.value,function(a){g.options[a]=h==a?"checked":""})):b.isObject(g.value)?(g.options=[],b.each(g.value,function(a,c){g.options.push({value:a,label:c,checked:b.indexOf(h,a)>-1?"checked":""})})):g.checked=g.value?"checked":"":"radio"==g.type&&(b.isArray(g.value)?(g.options={},b.each(g.value,function(a){g.options[a]=h==a?"checked":""})):b.isObject(g.value)&&(g.options=[],b.each(g.value,function(a,b){g.options.push({value:b,label:a,checked:h==b?"checked":""})}))),g.required=g.required?"required":""),g){var i=f.split("."),j=d,k=i.length;b.each(i,function(a,b){j[a]||(j[a]=b==k-1?g:{}),j=j[a]})}}),d},setFieldAttributes:function(c){var d={};return b.each(this.fieldAttributes,function(b,e){d[e]=a.extend(b,c[e])}),this.fieldAttributes=d,this},getFieldAttributes:function(){return this.fieldAttributes},render:function(){var a={fieldAttributes:this.fieldAttributes};return this.templateHelpers&&b.extend(a,this.templateHelpers),this.$el.html(this.template(a)),this},setAction:function(a){if(!(a.parent instanceof c.Siren.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone.Siren Model';return this.action=a,this.model=a.parent,this},initializeForm:function(a){var b=a.action;if(!b)throw'Missing required property: "action"';this.setAction(b),this.cid?this.$el.attr(this.parseAttributes(b,a.attributes)):a.attributes=this.parseAttributes(a.action,a.attributes),this.fieldAttributes=this.parseFieldAttributes(b,a.fieldAttributes)},initialize:function(){this.render()},constructor:function(a){a=a||{},a.action&&this.initializeForm(a),this.events=b.extend(this._events,this.events),c.View.call(this,a)}}),c});