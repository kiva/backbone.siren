/*
* Backbone.Siren v0.2.1
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
define(["jquery","underscore","backbone"],function(e,t,n){n.Siren=function(t,n){"use strict";function i(e,i){t.extend(this,e),this.parent=i,this.store=new n.Model}function a(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})}function r(e){var t,n;return e.href?n=e.href:e.links?(t=e.links.filter(function(e){return!(!e.rel||!e.rel.filter(function(e){return"self"==e}).length)})[0],t&&(n=t.href)):(N('Missing href or "self" link'),n=""),n}function u(){return r(this._data)}function o(e){return e["class"]||[]}function s(e,n){return t.filter(e,function(e){return l(e,n)})}function l(e,t){var n=!0;return t.className&&(n=e.hasClass(t.className)),t.rel&&(n=e.hasRel(t.rel)),n}function c(e,t){var n=!0;return t.className&&(n=d(e,t.className)),t.name&&(n=e.name==t.name),n}function d(e,n){return t.indexOf(o(e),n)>-1}function F(e){return d(this._data,e)}function f(e){return t.indexOf(this.rels(),e)>-1}function h(){return o(this._data)}function v(e){var n=this._data.links;return e&&(n=t.filter(n,function(n){return t.indexOf(n.rel,e)>-1})),n||[]}function p(i){var a=[],r=this.links(i);return t.each(r,function(t){a.push(e.getJSON(t.href,function(e){n.Siren.parseEntity(e)}))}),a}function m(t,n){return S(this,C(t),new e.Deferred,n)}function A(e){return e.rel||[]}function D(e){var n;return t.find(A(e),function(e){return n=/name:(.*)/.exec(e)}),t.last(n)}function y(e){return e.name||D(e)}function x(e){var n=this._actions;return e&&(n=t.filter(n,function(t){return c(t,e)})),n}function g(e,i){var a,r=this.getActionByName(e),u=this;return r&&(a={},t.each(r.fields,function(e){var t=u instanceof n.Siren.Model?u.get(e.name):u.meta(e.name);a[e.name]=i&&t instanceof n.Siren.Model?t.getAllByAction(e.action):t})),a}function b(e){return t.find(this._actions,function(t){return t.name==e})}function E(){return this._data.title}function _(){var e=this,i=[];return t.each(e._data.actions,function(r){var u=new n.Siren.Action(r,e);i.push(u),r.name?e[a(r.name)]=t.bind(u.execute,u):N("Action is missing a name, unable to add top level method",r)}),e._actions=i,i}function C(e){return"string"==typeof e&&(e=e.replace(/^#|#$/,"").split("#")),e}function S(e,t,i,a){a=a||{};var r=t.shift(),u=e.get(r);if(!u)throw'The entity you are looking for, "'+r+'" is not a sub-entity at '+e.url()+".";return a.deferred=i,n.Siren.resolve(u.url()+"#"+t.join("#"),a)}function w(e,n,i,a){t.isEmpty(n)?i.resolve(e):S(e,n,i,a)}var z={},M={},k={add:function(e){return z[e.url()]=e},get:function(e){return z["object"==typeof e?r(e):e]},exists:function(e){return!!this.get(e instanceof n.Siren.Model?e.url():e)},all:function(){return z},clear:function(){z={}},addRequest:function(e,t){M[e]=t},getRequest:function(e){return M[e]}},N=function(){n.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return i.prototype={getFieldByName:function(e){return t.find(this.fields,function(t){return t.name==e})},execute:function(e){e=e||{};var n,i=e.attributes,a=this.name,r=this.parent,u={url:this.href,actionName:a};return delete e.attributes,r?(this.method&&(u.type=this.method),this.type&&(u.contentType=this.type),n=r.clone(),n._data=r._data,n._actions=r._actions,e=t.extend(u,e),e.success=function(e,t,i){r.trigger("sync:"+a,e,t,i),r.attributes={},r.set(n.attributes)},i=t.extend(r.getAllByAction(this.name),i),n.save(i,e)):undefined}},{settings:{showWarnings:!0},store:k,warn:N,Action:i,parse:function(e){var t;return d(e,"collection")?t=new n.Siren.Collection(e):d(e,"error")?N("@todo - errors"):t=new n.Siren.Model(e),t},ajax:function(e,i){return i=t.extend({url:e,dataType:"json"},i),n.ajax(i)},resolve:function(i,a){a=a||{};var r,u,o,s,l=C(i),c=l.shift(),d=a.deferred;return o=k.getRequest(c),o&&(r=o.state()),t.isEmpty(l)&&("resolved"==r&&!a.forceFetch||"pending"==r)?d?o.done(function(e){d.resolve(e)}):o:(d||(d=new e.Deferred),"pending"==r?o.done(function(e){S(e,l,d,a)}):a.forceFetch||!(s=k.get(c))?(u=new e.Deferred,k.addRequest(c,u.promise()),n.Siren.ajax(c,a).done(function(e){var t=n.Siren.parse(e);u.resolve(t),w(t,l,d,a)})):w(s,l,d,a),d.promise())},Model:n.Model.extend({url:u,classes:h,hasClass:F,hasRel:f,title:E,actions:x,links:v,getActionByName:b,getAllByAction:g,parseActions:_,request:p,resolveChain:m,resolveEntities:function(n){var i=this,a=[];return t.each(this._data.entities,function(e){a.push(i.resolveEntity(e,n))}),e.when(a).done(function(){i.trigger("resolve",i)})},resolveEntity:function(t,i){i=i||{};var a,u,o=this,s=new e.Deferred;return t.href&&"linked"==i.autoFetch||"all"==i.autoFetch?n.Siren.resolve(r(t),i).done(function(e){s.resolve(o.setEntity(e,A(t),y(t)))}):(a=n.Siren.parse(t),u=s.resolve(this.setEntity(a,A(t),y(t)))),u},setEntity:function(e,t,n){var i={rel:t,entity:e};return n&&(this.set(n,e),i.name=n),this._entities.push(i),e},resolve:function(t){t=t||{};var n=new e.Deferred;return this.once("sync",function(e){n.resolve(e)}),t.forceFetch||this._data.href&&!this._data.links?this.fetch(t):n.resolve(this),n.promise()},parse:function(e,t){return this._data=e,this._entities=[],this.resolveEntities(t),this.parseActions(t),e.links&&!e.href&&k.add(this),e.properties},toJSON:function(e){var i,a={},r=this;return e&&e.actionName?(i=this.getActionByName(e.actionName),i&&t.each(i.fields,function(e){var t=r instanceof n.Siren.Model?r.get(e.name):r.meta(e.name);a[e.name]=t instanceof n.Siren.Model?t.toJSON({actionName:e.action}):t})):t.each(this.attributes,function(t,i){a[i]=t instanceof n.Siren.Model||t instanceof n.Siren.Collection?t.toJSON(e):t}),a},entities:function(e){var n=t.map(this._entities,function(e){return e.entity});return e&&(n=s(n,e)),n},constructor:function(e,t){t=t||{},t.parse=!0,n.Model.call(this,e,t)}}),Collection:n.Collection.extend({url:u,classes:h,hasClass:F,hasRel:f,title:E,links:v,actions:x,getActionByName:b,getAllByAction:g,parseActions:_,request:p,resolveChain:m,filter:function(e){return"function"==typeof e?t.filter(this,e):s(this,e)},resolve:function(t){t=t||{};var n=new e.Deferred;return this.once("sync",function(e){n.resolve(e)}),t.forceFetch||this._data.href&&!this._data.links?this.fetch(t):n.resolve(this),n.promise()},parse:function(e,i){this._data=e,this._meta=e.properties||{};var a=[];return t.each(e.entities,function(e){a.push(new n.Siren.Model(e))}),this.parseActions(i),a},meta:function(e){return this._meta[e]},constructor:function(e,t){t=t||{},t.parse=!0,n.Collection.call(this,e,t)}})}}(t,n),function(e,t){"use strict";t.Siren.validate={customPatterns:{},standardPatterns:{},setPatterns:function(t){var n=this,i="color date datetime datetime-local email month number range search tel time url week";e.each(t,function(e,t){-1==i.indexOf(t)?n.customPatterns[t]=e:n.standardPatterns[t]=e})}},e.extend(t.Siren.Model.prototype,{_validate:function(e,t){var n;return!t.xhr&&t.validate&&this.validate?(n=this.validationError=this.validate(e,t)||null,n&&this.trigger("invalid",this,n,t||{}),!(n&&!t.forceUpdate)):!0},validateEmptyField:function(e){return e.required?{valid:!1,valueMissing:!0}:{}},validateSubEntity:function(e,t){var n=t.action;return e._validate(e.getAllByAction(n),{validate:!0,actionName:n})?{}:{customError:!0,valid:!1}},validateType:function(e,n){var i={},a=n.type,r=t.Siren.validate.customPatterns[a]||t.Siren.validate.standardPatterns[a];return r&&(r.test(e)||(i.valid=!1,i.typeMismatch=!0)),i},validateConstraints:function(e,t){var n={},i=t.type;return t.pattern&&!RegExp(t.pattern).test(e)&&(n.valid=!1,n.patternMismatch=!0),"number"==i||"range"==i?(t.min&&t.min>e&&(n.valid=!1,n.rangeUnderflow=!0),t.max&&e>t.max&&(n.valid=!1,n.rangeOverflow=!0),t.step&&e%t.step&&(n.valid=!1,n.stepMismatch=!0)):"text email search password tel url".indexOf(i)>-1?t.maxlength&&t.maxlength<e.length&&(n.valid=!1,n.tooLong=!0):"file"==i&&t.maxSize&&t.maxSize<e.length&&(n.valid=!1,n.customError=!0),n},validateOne:function(n,i){var a={valueMissing:!1,typeMismatch:!1,patternMismatch:!1,tooLong:!1,rangeUnderflow:!1,rangeOverflow:!1,stepMismatch:!1,badInput:!1,customError:!1,valid:!0};return n?(e.extend(a,this.validateType(n,i)),a.typeMismatch||(n instanceof t.Model?e.extend(a,this.validateSubEntity(n,i)):e.extend(a,this.validateConstraints(n,i)))):a=e.extend(a,this.validateEmptyField(i)),a},validate:function(t,n){n=n||{};var i=this,a=n.actionName,r=this.getActionByName(a),u={};return r?e.each(r.fields,function(e){var a=e.name,r=t[a],o=i.validateOne(r,e,n);o.valid||(u[a]=o)}):u["no-actions"]='There are no actions matching the name, "'+a+'"',e.isEmpty(u)?void 0:u}})}(t,n);var i={phone:/([\+][0-9]{1,3}([ \.\-])?)?([\(]{1}[0-9]{3}[\)])?([0-9A-Z \.\-]{1,32})((x|ext|extension)?[0-9]{1,4}?)/,email:/((([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?/,url:/(https?|ftp):\/\/(((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?/,number:/-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?/,dateISO:/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/,alpha:/[a-zA-Z]+/,alphaNumeric:/\w+/,integer:/-?\d+/};n.Siren.validate.setPatterns(i),function(e,t){"use strict";e.extend(t.Siren.Model.prototype,{})}(t,n),function(t,n){"use strict";function i(e,t){return t=t||{},{id:t.id||e.name+"-form",enctype:t.enctype||e.type,method:t.method||e.method,action:t.action||e.href,title:t.title||e.title,novalidate:!t.validation}}function a(e,n){n=n||{};var i={},a=e.fields;return t.each(a,function(a){var r,u,o;if("entity"==a.type?console.log("@todo - how to handle sub-entity views?"):"entity"!=a.type&&(r=a.name,o=e.parent.get(r),u=t.extend({value:o,type:"text"},a,n[r]),"checkbox"==u.type?(u.checked=u.value?"checked":"",delete u.value):"radio"==u.type&&(t.isArray(u.value)?(u.options={},t.each(u.value,function(e){u.options[e]=o==e?"checked":""})):t.isObject(u.value)&&(u.options=[],t.each(u.value,function(e,t){u.options.push({value:t,label:e,checked:o==t?"checked":""})}))),u.required=u.required?"required":""),u){var s=r.split("."),l=i,c=s.length;t.each(s,function(e,t){l[e]||(l[e]=t==c-1?u:{}),l=l[e]})}}),i}n.Siren.FormView=n.View.extend({tagName:"form",events:{submit:"handleFormSubmit"},handleFormSubmit:function(e){e.preventDefault();var i=this,a={};t.each(this.fieldAttributes,function(e,t){var r=e.model;r&&(r instanceof n.Model?a[t]=r.get(t):"function"==typeof r&&(a[t]=r.call(i)))}),this.model.getActionByName(this.action.name).execute({attributes:a})},template:function(e){var n='<% _.each(data.fieldAttributes, function (field, fieldName) { %>                         <div>                             <% if (field.label) { %><label for="<%= field.id %>"><%= field.label %></label><% } %>                             <% if (field.type == "radio" && _.isArray(field.value)) { %>                                <% _.each(field.options, function (checked, val) { %><input type="radio" name="<%= fieldName %>" value="<%= val %>"  <%= checked %> /><% }); %>                            <% } else if (field.type == "radio" && _.isObject(field.value)) { %>                                <% _.each(field.options, function (option, name) { %><input type="radio" name="<%= fieldName %>" value="<%= option.value %>"  <%= option.checked %> /><label><%= option.label %></label><% }); %>                            <% } else { %>                                 <input type="<%= field.type %>" name="<%= fieldName %>" <% if (field.id) { %> id="<%= field.id %>" <% } if (field.value) { %> value="<%= field.value %>" <% } %>  <%= field.checked %> <%= field.required %> />                             <% } %>                         </div>                     <% }); %> <button type="submit" class="submitButton">Submit</button>';return t.template(n,e,{variable:"data"})},setFieldAttributes:function(n){var i={};return t.each(this.fieldAttributes,function(t,a){i[a]=e.extend(t,n[a])}),this.fieldAttributes=i,this},getFieldAttributes:function(){return this.fieldAttributes},render:function(){var e={fieldAttributes:this.fieldAttributes};return this.templateHelpers&&t.extend(e,this.templateHelpers),this.$el.html(this.template(e)),this},setAction:function(e){if(!(e.parent instanceof n.Siren.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone.Siren Model';return this.action=e,this.model=e.parent,this},initializeForm:function(e){var t=e.action;if(!t)throw'Missing required property: "action"';this.setAction(t),this.cid?this.$el.attr(i(t,e.attributes)):e.attributes=i(e.action,e.attributes),this.fieldAttributes=a(t,e.fieldAttributes)},initialize:function(){this.render()},constructor:function(e){e=e||{},e.validateOnChange=void 0===e.validateOnChange?!0:e.validateOnChange,e.action&&this.initializeForm(e),n.View.call(this,e)}})}(t,n)});