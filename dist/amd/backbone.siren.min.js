/*
* Backbone.Siren v0.2.9
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
define(["jquery","underscore","backbone"],function(e,t,n){return n.Siren=function(t,n,i){"use strict";function r(e,n){var i;t.extend(this,{"class":[],method:"GET",type:"application/x-www-form-urlencoded"},e),this.class.indexOf("batch")>-1&&t.isEmpty(this.fields)&&(i=n.first(),i&&(this.fields=i.getActionByName(this.name).fields)),this.parent=n}function s(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})}function o(e){var t,n;if(e)return e.href?n=e.href:e.links?(t=e.links.filter(function(e){return!(!e.rel||!e.rel.filter(function(e){return"self"==e}).length)})[0],t&&(n=t.href)):(E('Missing href or "self" link'),n=""),n}function a(){return o(this._data)}function u(e){return e["class"]||[]}function c(e,n){return t.filter(e,function(e){return l(e,n)})}function l(e,t){var n=!0;return t.className&&(n=e.hasClass(t.className)),t.rel&&(n=e.hasRel(t.rel)),n}function f(e,t){var n=!0;return t.className&&(n=h(e,t.className)),t.name&&(n=e.name==t.name),n}function h(e,n){return t.indexOf(u(e),n)>-1}function d(e){return h(this._data,e)}function p(e){return t.indexOf(this.rels(),e)>-1}function v(){return u(this._data)}function m(e){var n=this._data.links;return e&&(n=t.filter(n,function(n){return t.indexOf(n.rel,e)>-1})),n||[]}function y(e){var i=t.find(this._data.links,function(n){return t.indexOf(n.rel,e)>-1});if(i)return n.Siren.resolve(i.href)}function b(i){i=i||{};var r=new e.Deferred;if(this.once("sync",function(e){r.resolve(e)}),i.forceFetch||this._data&&this._data.href&&!this._data.links)this.fetch(i);else if(t.isEmpty(this._data)){if(i.url){var s=this,o=n.Siren.parseChain(i.url),a=o.pop();delete i.url,a&&!o.length?this.resolve(t.extend(t.clone(i),{url:a,forceFetch:!0})).done(function(e){r.resolve(e)}):a&&n.Siren.resolve(o,i).done(function(e){s.resolve(t.extend(t.clone(i),{url:e.get(a).url(),forceFetch:!0})).done(function(e){r.resolve(e)})})}}else r.resolve(this);return r.promise()}function g(t,i){return C(this,n.Siren.parseChain(t),new e.Deferred,i)}function S(e){return e.rel||[]}function _(e){var n;return t.find(S(e),function(e){return n=/name:(.*)/.exec(e)}),t.last(n)}function x(e){return e.name||_(e)}function A(e){var n=this._actions;return e&&(n=t.filter(n,function(t){return f(t,e)})),n}function k(e){return t.find(this._actions,function(t){return t.name==e})}function N(){return this._data.title}function w(){var e=this,i=[];if(this._data)return t.each(this._data.actions,function(r){var o=new n.Siren.Action(r,e);i.push(o),r.name?e[s(r.name)]=t.bind(o.execute,o):E("Action is missing a name, unable to add top level method",r)}),e._actions=i,i}function C(e,t,i,r){r=r||{};var s=t.shift(),o=e.get(s);if(!o)throw'The entity you are looking for, "'+s+'" is not a sub-entity at '+e.url()+".";return r.deferred=i,n.Siren.resolve(o.url()+"#"+t.join("#"),r)}function F(e,n,i,r){t.isEmpty(n)?i.resolve(e):C(e,n,i,r)}var M={},O={},q={add:function(e){M[e.url()]=e},get:function(e){return M["object"==typeof e?o(e):e]},filter:function(e){return t.filter(M,function(t,n){return e.test(n)})},exists:function(e){return!!this.get(e instanceof n.Siren.Model?e.url():e)},all:function(){return M},clear:function(){M={}},addRequest:function(e,t){O[e]=t},getRequest:function(e){return O[e]}},E=function(){n.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return r.prototype={hasClass:function(e){return this.class.indexOf(e)>-1},getFieldByName:function(e){return t.find(this.fields,function(t){return t.name==e})},getSecureKeys:function(){var e=this.secureKeys;return e?e:(this.secureKeys=new n.Model,this.secureKeys)},setSecureKey:function(e,t){var n=this.getSecureKeys();n.set(e,t)},getSecureKey:function(e){var t=this.secureKeys;return t?t.get(e):i},clearSecureKey:function(e){return this.getSecureKeys().unset(e)},clearSecureKeys:function(){return this.getSecureKeys().clear()},execute:function(e){e=e||{};var r,s,o=e.attributes,a=this.name,u=this.parent,c={url:this.href,actionName:a,success:function(e,t,i){u.trigger("sync:"+a,e,t,i),u instanceof n.Model?(u.attributes={},u.set(r.attributes)):u.set(r.models)},error:function(e,t,n){u.trigger("error:"+a,e,t,n)}};return delete e.attributes,u?(this.method&&(c.type=this.method),this.type&&(c.contentType=this.type),u instanceof n.Model?(r=u.clone(),r._data=u._data,r._actions=u._actions):r=u,r.on("request",function(){u.trigger("request"),u.trigger("request:"+a)}),e=t.extend(c,e),o=t.extend(u.toJSON({actionName:this.name}),o),s=r.save(o,e),u.validationError=r.validationError,s):i}},{settings:{showWarnings:!0},store:q,warn:E,Action:r,parse:function(e){var t;return t=h(e,"collection")?new n.Siren.Collection(e):h(e,"error")?new n.Siren.Model(e):new n.Siren.Model(e)},ajax:function(e,i){return i=t.extend({url:e,dataType:"json"},i),n.ajax(i)},parseChain:function(e){return"string"==typeof e&&(e=e.replace(/^#|#$/,"").split("#")),e},resolve:function b(i,r){r=r||{};var s,o,a,u,c=n.Siren.parseChain(i),l=c.shift(),f=r.deferred;return a=q.getRequest(l),a&&(s=a.state()),t.isEmpty(c)&&("resolved"==s&&!r.forceFetch||"pending"==s)?f?a.done(function(e){f.resolve(e)}):a:(f||(f=new e.Deferred),"pending"==s?a.done(function(e){C(e,c,f,r)}):r.forceFetch||!(u=q.get(l))?(o=new e.Deferred,q.addRequest(l,o.promise()),n.Siren.ajax(l,r).done(function(e){var t=n.Siren.parse(e);o.resolve(t),F(t,c,f,r)}).fail(function(e){var t=JSON.parse(e.responseText||"{}"),i=n.Siren.parse(t);o.reject(i,e),f.reject(i,e)})):F(u,c,f,r),f.promise())},Model:n.Model.extend({url:a,classes:v,hasClass:d,hasRel:p,title:N,actions:A,links:m,getActionByName:k,parseActions:w,request:y,resolve:b,resolveChain:g,resolveEntities:function(n){var i=this,r=[];return t.each(this._data.entities,function(e){r.push(i.resolveEntity(e,n))}),e.when(r).done(function(){i.trigger("resolve",i)})},resolveEntity:function(t,i){i=i||{};var r,s,a=this,u=new e.Deferred;return t.href&&"linked"==i.autoFetch||"all"==i.autoFetch?n.Siren.resolve(o(t),i).done(function(e){u.resolve(a.setEntity(e,S(t),x(t)))}):(r=n.Siren.parse(t),s=u.resolve(this.setEntity(r,S(t),x(t)))),s},setEntity:function(e,t,n){var i={rel:t,entity:e};return n&&(this.set(n,e),i.name=n),this._entities.push(i),e},parse:function(e,t){return this._data=e,this._entities=[],this.resolveEntities(t),e.links&&!e.href&&q.add(this),e.properties},toJSON:function(e){var i,r={},s=this;return e&&e.actionName&&(i=this.getActionByName(e.actionName)),i?t.each(i.fields,function(e){var t=s.get(e.name);r[e.name]=t instanceof n.Siren.Model||t instanceof n.Siren.Collection?t.toJSON({actionName:e.action}):t}):t.each(this.attributes,function(t,i){r[i]=t instanceof n.Siren.Model||t instanceof n.Siren.Collection?t.toJSON(e):t}),r},entities:function(e){var n=t.map(this._entities,function(e){return e.entity});return e&&(n=c(n,e)),n},constructor:function(e,t){t=t||{},t.parse=!0,n.Model.call(this,e,t),this.parseActions()}}),Collection:n.Collection.extend({url:a,classes:v,hasClass:d,hasRel:p,title:N,links:m,actions:A,getActionByName:k,parseActions:w,request:y,resolve:b,resolveChain:g,filter:function(e){return"function"==typeof e?t.filter(this,e):c(this,e)},parse:function(e){this._data=e,this._meta=e.properties||{};var i=[];return t.each(e.entities,function(e){i.push(new n.Siren.Model(e))}),i},meta:function(e){return this._meta[e]},toJSON:function(e){return e=e||{},this.map(function(t){var n=t.toJSON(e);return e.actionName&&(n.id=t.id),n})},save:function(e,n){return n=t.extend({validate:!0},n),this._validate&&this._validate(e,n),n.parse===i&&(n.parse=!0),this.sync("create",this,n)},constructor:function(e,t){t=t||{},t.parse=!0,n.Collection.call(this,e,t),this.parseActions()}})}}(t,n),function(t,n){"use strict";n.Siren.FormView=n.View.extend({tagName:"form",_events:{submit:"handleFormSubmit"},handleFormSubmit:function(e){e.preventDefault();var i=this,r={};t.each(this.fieldAttributes,function(e,t){var s=e.model;s&&(s instanceof n.Model?r[t]=s.get(t):e.isSecure?(r[t]=s.action.getSecureKey(t),s.action.clearSecurekeys()):"function"==typeof s&&(r[t]=s.call(i)))}),this.model.getActionByName(this.action.name).execute({attributes:r})},template:function(e){var n='<% _.each(data.fieldAttributes, function (field, fieldName) { %>                         <div>                             <% if (field.label) { %><label for="<%= field.id %>"><%= field.label %></label><% } %>                             <% if ((field.type == "radio" || field.type == "checkbox") && _.isArray(field.value)) { %>                                <% _.each(field.options, function (checked, val) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= val %>"  <%= checked %> /><% }); %>                            <% } else if ((field.type == "radio" || field.type == "checkbox") && _.isObject(field.value)) { %>                                <% _.each(field.options, function (option, name) { %><input type="<%= field.type %>" name="<%= fieldName %>" value="<%= option.value %>"  <%= option.checked %> /><label><%= option.label %></label><% }); %>                            <% } else { %>                                 <input type="<%= field.type %>" name="<%= fieldName %>" <% if (field.id) { %> id="<%= field.id %>" <% } if (field.value) { %> value="<%= field.value %>" <% } %>  <%= field.checked %> <%= field.required %> />                             <% } %>                         </div>                     <% }); %> <button type="submit" class="submitButton">Submit</button>';return t.template(n,e,{variable:"data"})},parseAttributes:function(e,t){return t=t||{},{id:t.id||e.name+"-form",enctype:t.enctype||e.type,method:t.method||e.method,action:t.action||e.href,title:t.title||e.title,novalidate:!t.validation}},parseFieldAttributes:function(e,n){n=n||{};var i={},r=e.fields;return t.each(r,function(r){var s,o,a;if("entity"==r.type?console.log("@todo - how to handle sub-entity views?"):"entity"!=r.type&&(s=r.name,a=e.parent.get(s),o=t.extend({value:a,type:"text"},r,n[s]),"checkbox"==o.type?t.isArray(o.value)?(o.options={},t.each(o.value,function(e){o.options[e]=a==e?"checked":""})):t.isObject(o.value)?(o.options=[],t.each(o.value,function(e,n){o.options.push({value:e,label:n,checked:t.indexOf(a,e)>-1?"checked":""})})):o.checked=o.value?"checked":"":"radio"==o.type&&(t.isArray(o.value)?(o.options={},t.each(o.value,function(e){o.options[e]=a==e?"checked":""})):t.isObject(o.value)&&(o.options=[],t.each(o.value,function(e,t){o.options.push({value:t,label:e,checked:a==t?"checked":""})}))),o.required=o.required?"required":""),o){var u=s.split("."),c=i,l=u.length;t.each(u,function(e,t){c[e]||(c[e]=t==l-1?o:{}),c=c[e]})}}),i},setFieldAttributes:function(n){var i={};return t.each(this.fieldAttributes,function(t,r){i[r]=e.extend(t,n[r])}),this.fieldAttributes=i,this},getFieldAttributes:function(){return this.fieldAttributes},render:function(){var e={fieldAttributes:this.fieldAttributes};return this.templateHelpers&&t.extend(e,this.templateHelpers),this.$el.html(this.template(e)),this},setAction:function(e){if(!(e.parent instanceof n.Siren.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone.Siren Model';return this.action=e,this.model=e.parent,this},initializeForm:function(e){var t=e.action;if(!t)throw'Missing required property: "action"';this.setAction(t),this.cid?this.$el.attr(this.parseAttributes(t,e.attributes)):e.attributes=this.parseAttributes(e.action,e.attributes),this.fieldAttributes=this.parseFieldAttributes(t,e.fieldAttributes)},initialize:function(){this.render()},constructor:function(e){e=e||{},e.action&&this.initializeForm(e),this.events=t.extend(this._events,this.events),n.View.call(this,e)}})}(t,n),n});