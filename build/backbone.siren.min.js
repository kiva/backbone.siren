/*
* Backbone.Siren v0.1.0
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
Backbone.Siren=function(t,e){"use strict";function n(e,n){t.extend(this,e),this.parent=n}function i(t){return t.replace(/(\-[a-z])/g,function(t){return t.toUpperCase().replace("-","")})}function a(t){var e,n;return t.href?n=t.href:t.links?(e=t.links.filter(function(t){return!(!t.rel||!t.rel.filter(function(t){return"self"==t}).length)})[0],e&&(n=e.href)):(w('Missing href or "self" link'),n=""),n}function r(){return a(this._data)}function o(t){return t["class"]||[]}function s(e,n){return t.filter(e,function(t){return l(t,n)})}function l(t,e){var n=!0;return e.className&&(n=t.hasClass(e.className)),e.rel&&(n=t.rel()==e.rel),n}function c(t,e){var n=!0;return e.className&&(n=u(t,e.className)),e.name&&(n=t.name==e.name),n}function u(e,n){return t.indexOf(o(e),n)>-1}function d(t){return u(this._data,t)}function h(){return o(this._data)}function f(e){var n=this._data.links;return e&&(n=t.filter(n,function(n){return t.indexOf(n.rel,e)>-1})),n||[]}function m(e){var n=this,i=[],a=this.links(e);return t.each(a,function(t){i.push($.getJSON(t.href,function(t){n.parseEntity(t)}))}),i}function p(t){var e=t.rel;return e&&(e=e[0],e=e.slice(e.lastIndexOf("/")+1,e.length)),e}function v(){return p(this._data)}function g(e){var n=this._actions;return e&&(n=t.filter(n,function(t){return c(t,e)})),n}function y(n){var i,a=this.getActionByName(n),r=this;return a&&(i={},t.each(a.fields,function(t){i[t.name]=r instanceof e.Model?r.get(t.name):r.meta(t.name)})),i}function x(e){return t.find(this._actions,function(t){return t.name==e})}function b(){return this._data.title}function A(){var n=this,a=[];return t.each(n._data.actions,function(r){var o=new e.Siren.Action(r,n);a.push(o),r.name?n[i(r.name)]=t.bind(o.execute,o):w("Action is missing a name, unable to add top level method",r)}),n._actions=a,a}var _={},S={add:function(t){return _[t.url()]=t},exists:function(t){return!!_[t.url()]},all:function(){return _}},w=function(){e.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return n.prototype={getFieldByName:function(e){return t.find(this.fields,function(t){return t.name==e})},execute:function(e){if(this.parent){var n={url:this.href,actionName:this.name,method:this.method,type:this.type,validate:!0,patch:!0,content:"application/vnd.siren+json"};return e=t.extend(n,e),this.parent.save(this.parent.getAllByAction(this.name),e)}}},{settings:{showWarnings:!0},store:S,warn:w,Action:n,Model:e.Model.extend({url:r,classes:h,hasClass:d,rel:v,title:b,actions:g,links:f,getActionByName:x,getAllByAction:y,parseActions:A,request:m,resolveEntities:function(e,n){var i=this,a=[];return t.each(e.entities,function(t){t.href&&"linked"==n.autoFetch||"all"==n.autoFetch?a.push(i.fetchEntity(t,n)):a.push(i.addEntity(t,n))}),$.when(a).done(function(){i.trigger("resolve",i)})},parse:function(t,e){return this._data=t,this._entities=[],this.resolveEntities(t,e),this.parseActions(e),t.properties},toJSON:function(){var e=t.clone(this.attributes),n=this.entities();return t.each(n,function(t){e[t.rel()]=t}),e},entities:function(e){var n=this,i=t.filter(this,function(e,i){return t.indexOf(n._entities,i)>-1});return e&&(i=s(i,e)),i},fetchEntity:function(t){var e=this;return $.getJSON(a(t),function(t){e.addEntity(t)})},parseEntity:function(t){var n;return u(t,"collection")?n=new e.Siren.Collection(t):u(t,"error")?w("@todo - errors"):(n=new e.Siren.Model(t),S.add(n)),n},addEntity:function(t){var e=this.parseEntity(t),n=e.rel();return this.set(n,e),this._entities.push(n),e},constructor:function(t,n){n=n||{},n.parse=!0,e.Model.call(this,t,n)}}),Collection:e.Collection.extend({url:r,classes:h,hasClass:d,title:b,rel:v,links:f,actions:g,getActionByName:x,getAllByAction:y,parseActions:A,request:m,toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},filter:function(e){return"function"==typeof e?t.filter(this,e):s(this,e)},parse:function(n,i){this._data=n,this._meta=n.properties||{};var a=[];return t.each(n.entities,function(t){var n=new e.Siren.Model(t);a.push(n),S.add(n)}),this.parseActions(i),a},meta:function(t){return this._meta[t]},constructor:function(t,n){n=n||{},n.parse=!0,e.Collection.call(this,t,n)}})}}(_,Backbone),function(t,e){"use strict";e.Siren.validate={customPatterns:{},standardPatterns:{},setPatterns:function(e){var n=this,i="color date datetime datetime-local email month number range search tel time url week";t.each(e,function(t,e){-1==i.indexOf(e)?n.customPatterns[e]=t:n.standardPatterns[e]=t})}},t.extend(e.Siren.Model.prototype,{_validate:function(t,e){var n;return e.validate&&this.validate?(n=this.validationError=this.validate(t,e)||null,n&&this.trigger("invalid",this,n,e||{}),!(n&&!e.forceUpdate)):!0},validateEmptyField:function(t){return t.required?{valid:!1,valueMissing:!0}:{}},validateSubEntity:function(t,e){var n=e.action;return t._validate(t.getAllByAction(n),{validate:!0,actionName:n})?{}:{customError:!0,valid:!1}},validateType:function(t,n){var i={},a=n.type,r=e.Siren.validate.customPatterns[a]||e.Siren.validate.standardPatterns[a];return r?r.test(t)||(i.valid=!1,i.typeMismatch=!0):a&&"text"!=a&&"entity"!=a&&e.Siren.warn('Unable to validate type, "'+a+'" as it does not have a matching validation rule.'),i},validateConstraints:function(t,e){var n={},i=e.type;return e.pattern&&!RegExp(e.pattern).test(t)&&(n.valid=!1,n.patternMismatch=!0),"number"==i||"range"==i?(e.min&&e.min>t&&(n.valid=!1,n.rangeUnderflow=!0),e.max&&t>e.max&&(n.valid=!1,n.rangeOverflow=!0),e.step&&t%e.step&&(n.valid=!1,n.stepMismatch=!0)):"text email search password tel url".indexOf(i)>-1&&e.maxlength&&e.maxlength<t.length&&(n.valid=!1,n.tooLong=!0),n},validateOne:function(n,i){var a={valueMissing:!1,typeMismatch:!1,patternMismatch:!1,tooLong:!1,rangeUnderflow:!1,rangeOverflow:!1,stepMismatch:!1,badInput:!1,customError:!1,valid:!0};return n?(t.extend(a,this.validateType(n,i)),a.typeMismatch||(n instanceof e.Model?t.extend(a,this.validateSubEntity(n,i)):t.extend(a,this.validateConstraints(n,i)))):a=t.extend(a,this.validateEmptyField(i)),a},validate:function(e,n){n=n||{};var i=this,a=n.actionName,r=this.getActionByName(a),o={};return r?t.each(r.fields,function(t){var a=t.name,r=e[a],s=i.validateOne(r,t,n);s.valid||(o[a]=s)}):o["no-actions"]='There are no actions matching the name, "'+a+'"',t.isEmpty(o)?void 0:o}})}(_,Backbone),function(t,e){"use strict";t.extend(e.Siren.Model.prototype,{})}(_,Backbone),function(t,e){"use strict";function n(t,e){return e=e||{},{id:e.id||t.name+"-form",enctype:e.enctype||t.type,method:e.method||t.method,action:e.action||t.href,title:e.title||t.title,novalidate:!e.validation}}function i(e,n){n=n||{};var i=[],a=e.fields;return t.each(a,function(a){var r;"entity"!=a.type?(r=a.name,i.push(t.extend({value:e.parent.get(r)},a,n[r]))):"entity"==a.type&&console.log("@todo - how to handle sub-entity views?")}),i}e.Siren.FormView=e.View.extend({tagName:"form",events:{submit:"handleFormSubmit","change input, select":"handleFormElementChange"},handleFormSubmit:function(t){t.preventDefault(),this.model.getActionByName(this.action.name).execute()},handleFormElementChange:function(t){var e=$(t.target),n={};n[e.attr("name")]=e.val(),this.model.set(n,{validate:!!this.options.validateOnChange,actionName:this.action.name,forceUpdate:!0})},template:function(e){var n='<% _.each(fieldAttributes, function (field, fieldName) { %>                 <div>                     <label for="<%= field.id %>"><%= field.label %></label>                     <input type="<%= field.type %>" name="<%= field.name %>" id="<%= field.id %>" value="<%= field.value %>" />                 </div>             <% }); %> <input type="submit" class="submitButton" />';return t.template(n)(e)},parseAction:function(t){var a;if(!t||!t.action)throw'Missing required property: "action"';if(a=t.action,!(a.parent instanceof e.Siren.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone.Siren Model';return{attributes:n(a,t.formAttributes),fieldAttributes:i(a,t.fieldAttributes),model:a.parent,action:a}},render:function(t){return this.$el.html(this.template(t))},_render:function(t){return this.render(t)},constructor:function(n){n=t.extend({},n,{validateOnChange:!0});var i=this.parseAction(n);e.View.call(this,t.extend({},n,i)),this.action=i.action,this._render(i)}})}(_,Backbone);